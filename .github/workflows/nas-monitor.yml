name: NAS Status Monitor

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
  GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
  TG_BOT_TOKEN: '8205509147:AAF0V7WMmTcm1Mb0l_6k0BTjV6M78uPi6TY'
  TG_CHAT_ID: '-1003014622661'
  QYWX_WEBHOOK: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=a40aa293-1db3-491b-bac4-d8cbf019e918'

jobs:
  check-nas-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name "$GIT_USERNAME"
        git config --global user.email "$GIT_EMAIL"

    - name: æ£€æŸ¥NASé€šçŸ¥çŠ¶æ€
      id: check-notification
      run: |
        # æ£€æŸ¥data.jsonæ˜¯å¦å­˜åœ¨
        if [ ! -f "data.json" ]; then
          echo "data.json not found"
          exit 1
        fi

        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S")
        
        # ä½¿ç”¨Pythonè„šæœ¬æ£€æŸ¥é€šçŸ¥æ—¶é—´
        NOTIFICATION_TIME=$(python .github/scripts/check_notification.py)

        echo "Notification time: $NOTIFICATION_TIME"
        
        if [ "$NOTIFICATION_TIME" = "NOT_FOUND" ] || [ "$NOTIFICATION_TIME" = "ERROR" ]; then
          echo "status=not_found" >> $GITHUB_OUTPUT
          echo "needs_update=true" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡1.5å°æ—¶
          TIME_DIFF=$(python .github/scripts/check_time_diff.py "$NOTIFICATION_TIME")

          echo "Time difference check: $TIME_DIFF"
          echo "status=exists" >> $GITHUB_OUTPUT
          echo "needs_update=$TIME_DIFF" >> $GITHUB_OUTPUT
        fi

    - name: æ›´æ–°å¼‚å¸¸çŠ¶æ€
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        python .github/scripts/update_nas_status.py

    - name: å‘é€é€šçŸ¥
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        # è·å–åŒ—äº¬æ—¶é—´
        CURRENT_TIME=$(TZ='Asia/Shanghai' date +"%Y-%m-%dT%H:%M:%S")
        
        # æ„é€ é€šçŸ¥æ¶ˆæ¯
        MESSAGE="ğŸš¨ NASçŠ¶æ€å¼‚å¸¸è­¦å‘Š\n\nğŸ”´ GitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€å¼‚å¸¸\n\nğŸ“Š æ£€æµ‹æ—¶é—´: $CURRENT_TIME (åŒ—äº¬æ—¶é—´)\nâš ï¸ ç³»ç»Ÿå¯èƒ½å·²ç¦»çº¿ï¼Œè¯·åŠæ—¶æ£€æŸ¥\n\næ­¤é€šçŸ¥ç”±GitHub Actionè‡ªåŠ¨å‘é€"

        echo "å‘é€Telegramé€šçŸ¥..."
        curl -s --max-time 10 -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"$TG_CHAT_ID\",
            \"text\": \"$MESSAGE\",
            \"parse_mode\": \"Markdown\"
          }" || echo "Telegramé€šçŸ¥å‘é€å¤±è´¥"

        echo "å‘é€ä¼ä¸šå¾®ä¿¡æœºå™¨äººé€šçŸ¥..."
        curl -s --max-time 10 -X POST "$QYWX_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "{
            \"msgtype\": \"text\",
            \"text\": {
              \"content\": \"$MESSAGE\"
            }
          }" || echo "ä¼ä¸šå¾®ä¿¡æœºå™¨äººé€šçŸ¥å‘é€å¤±è´¥"

        echo "âœ… æ‰€æœ‰é€šçŸ¥å‘é€å®Œæˆ"

    - name: é…ç½®Gitè¿œç¨‹ä»“åº“è®¤è¯
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        # è·å–ä»“åº“URLå¹¶æ·»åŠ è®¤è¯ä¿¡æ¯
        REPO_URL="https://$GIT_USERNAME:$GIT_PASSWORD@github.com/${{ github.repository }}.git"
        git remote set-url origin $REPO_URL

    - name: æäº¤æ›´æ”¹
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        git add data.json
        git commit -m "ğŸ¤– GitHub Action: æ ‡è®°NASçŠ¶æ€ä¸ºå¼‚å¸¸ [è‡ªåŠ¨æ£€æµ‹]"
        git push origin main

    - name: è¾“å‡ºæ£€æµ‹ç»“æœ
      run: |
        echo "ğŸ“Š NASçŠ¶æ€æ£€æµ‹å®Œæˆ"
        echo "ğŸ” é€šçŸ¥çŠ¶æ€: ${{ steps.check-notification.outputs.status }}"
        echo "ğŸ”„ éœ€è¦æ›´æ–°: ${{ steps.check-notification.outputs.needs_update }}"
        echo "â° å½“å‰æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%dT%H:%M:%S')"