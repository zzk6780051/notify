name: NAS Status Monitor

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
  GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
  TG_BOT_TOKEN: '8205509147:AAF0V7WMmTcm1Mb0l_6k0BTjV6M78uPi6TY'
  TG_CHAT_ID: '-1003014622661'
  QYWX_WEBHOOK: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=a40aa293-1db3-491b-bac4-d8cbf019e918'
  WECOM_CORPID: 'wwdfda6b093b940020'
  WECOM_AGENT_ID: '1000002'
  WECOM_SECRET: 'pfti6ge3On7H9qUb7cH-ZVpVk6B_RfW48SGWm3nQkhU'
  WECOM_TO_USER: '@all'

jobs:
  check-nas-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name "$GIT_USERNAME"
        git config --global user.email "$GIT_EMAIL"

    - name: æ£€æŸ¥NASé€šçŸ¥çŠ¶æ€
      id: check-notification
      run: |
        # æ£€æŸ¥data.jsonæ˜¯å¦å­˜åœ¨
        if [ ! -f "data.json" ]; then
          echo "data.json not found"
          exit 1
        fi

        # è§£æžJSONå¹¶æ£€æŸ¥IDä¸º3çš„é€šçŸ¥
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S")
        
        # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ¥é¿å…Pythonç¼©è¿›é—®é¢˜
        cat > /tmp/check_notification.py << 'EOF'
import json, sys
from datetime import datetime, timedelta

try:
    with open('data.json', 'r') as f:
        data = json.load(f)
    
    for notification in data.get('notifications', []):
        if notification.get('id') == 3:
            print(notification.get('date', ''))
            break
    else:
        print('NOT_FOUND')
        
except Exception as e:
    print('ERROR')
EOF
        
        NOTIFICATION_TIME=$(python /tmp/check_notification.py)
        
        echo "Notification time: $NOTIFICATION_TIME"
        
        if [ "$NOTIFICATION_TIME" = "NOT_FOUND" ] || [ "$NOTIFICATION_TIME" = "ERROR" ]; then
          echo "status=not_found" >> $GITHUB_OUTPUT
          echo "needs_update=true" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡1.5å°æ—¶
          cat > /tmp/check_time_diff.py << EOF
from datetime import datetime, timedelta
import sys

current = datetime.utcnow()
notification_time = datetime.strptime('$NOTIFICATION_TIME', '%Y-%m-%dT%H:%M:%S')
diff = current - notification_time

if diff.total_seconds() > 5400:  # 1.5å°æ—¶ = 5400ç§’
    print('true')
else:
    print('false')
EOF
          
          TIME_DIFF=$(python /tmp/check_time_diff.py)
          
          echo "Time difference check: $TIME_DIFF"
          echo "status=exists" >> $GITHUB_OUTPUT
          echo "needs_update=$TIME_DIFF" >> $GITHUB_OUTPUT
        fi

    - name: æ›´æ–°å¼‚å¸¸çŠ¶æ€
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        python -c "
import json
from datetime import datetime

# è¯»å–çŽ°æœ‰æ•°æ®
with open('data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# æ›´æ–°IDä¸º3çš„é€šçŸ¥
current_time = datetime.now().strftime('%Y-%m-%dT%H:%M:%S')
nas_notification = None

for notification in data['notifications']:
    if notification['id'] == 3:
        nas_notification = notification
        break

if nas_notification:
    nas_notification['title'] = 'âŒ NASçŠ¶æ€å¼‚å¸¸ (è‡ªåŠ¨æ£€æµ‹)'
    nas_notification['content'] = 'ðŸ”´ NASçŠ¶æ€ç›‘æµ‹æŠ¥å‘Š - ' + current_time + '\n\nGitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€é€šçŸ¥è¶…è¿‡1.5å°æ—¶æœªæ›´æ–°ï¼Œç³»ç»Ÿå¯èƒ½å·²ç¦»çº¿ã€‚\n\nðŸ“Š æœ€åŽæ£€æµ‹æ—¶é—´: ' + current_time + '\n\nâš ï¸ æ³¨æ„: æ­¤çŠ¶æ€ç”±GitHub Actionè‡ªåŠ¨æ ‡è®°'
    nas_notification['date'] = current_time
else:
    nas_notification = {
        'id': 3,
        'title': 'âŒ NASçŠ¶æ€å¼‚å¸¸ (è‡ªåŠ¨æ£€æµ‹)',
        'content': 'ðŸ”´ NASçŠ¶æ€ç›‘æµ‹æŠ¥å‘Š - ' + current_time + '\n\nGitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€é€šçŸ¥é•¿æ—¶é—´æœªæ›´æ–°ã€‚\n\nðŸ“Š æœ€åŽæ£€æµ‹æ—¶é—´: ' + current_time + '\n\nâš ï¸ æ³¨æ„: æ­¤çŠ¶æ€ç”±GitHub Actionè‡ªåŠ¨æ ‡è®°',
        'date': current_time
    }
    data['notifications'].append(nas_notification)

# ä¿å­˜æ›´æ–°
with open('data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print('âœ… å·²æ›´æ–°NASå¼‚å¸¸çŠ¶æ€')
"

    - name: å‘é€é€šçŸ¥
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S")
        
        # æž„é€ é€šçŸ¥æ¶ˆæ¯ - ä½¿ç”¨å•è¡Œæ ¼å¼
        MESSAGE="ðŸš¨ NASçŠ¶æ€å¼‚å¸¸è­¦å‘Š\n\nðŸ”´ GitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€å¼‚å¸¸\n\nðŸ“Š æ£€æµ‹æ—¶é—´: $CURRENT_TIME\nâš ï¸ ç³»ç»Ÿå¯èƒ½å·²ç¦»çº¿ï¼Œè¯·åŠæ—¶æ£€æŸ¥\n\næ­¤é€šçŸ¥ç”±GitHub Actionè‡ªåŠ¨å‘é€"

        echo "å‘é€Telegramé€šçŸ¥..."
        curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
          -d chat_id="$TG_CHAT_ID" \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown" || echo "Telegramé€šçŸ¥å‘é€å¤±è´¥"

        echo "å‘é€ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººé€šçŸ¥..."
        # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ¥å¤„ç†JSONæ•°æ®
        cat > /tmp/qywx_payload.json << EOF
{
  "msgtype": "text",
  "text": {
    "content": "$MESSAGE"
  }
}
EOF
        curl -s -X POST "$QYWX_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d @/tmp/qywx_payload.json || echo "ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººé€šçŸ¥å‘é€å¤±è´¥"

        echo "å‘é€ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥..."
        # å…ˆèŽ·å–access_token
        ACCESS_TOKEN=$(curl -s -G "https://qyapi.weixin.qq.com/cgi-bin/gettoken" \
          --data-urlencode "corpid=$WECOM_CORPID" \
          --data-urlencode "corpsecret=$WECOM_SECRET" | python -c "import sys, json; print(json.load(sys.stdin).get('access_token', ''))")
        
        if [ -z "$ACCESS_TOKEN" ]; then
          echo "èŽ·å–ä¼ä¸šå¾®ä¿¡access_tokenå¤±è´¥"
        else
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å¤„ç†JSONæ•°æ®
          cat > /tmp/wecom_payload.json << EOF
{
  "touser": "$WECOM_TO_USER",
  "msgtype": "text",
  "agentid": $WECOM_AGENT_ID,
  "text": {
    "content": "$MESSAGE"
  },
  "safe": 0
}
EOF
          curl -s -X POST "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/wecom_payload.json || echo "ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥å‘é€å¤±è´¥"
        fi

    - name: é…ç½®Gitè¿œç¨‹ä»“åº“è®¤è¯
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        # èŽ·å–ä»“åº“URLå¹¶æ·»åŠ è®¤è¯ä¿¡æ¯
        REPO_URL="https://$GIT_USERNAME:$GIT_PASSWORD@github.com/${{ github.repository }}.git"
        git remote set-url origin $REPO_URL

    - name: æäº¤æ›´æ”¹
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        git add data.json
        git commit -m "ðŸ¤– GitHub Action: æ ‡è®°NASçŠ¶æ€ä¸ºå¼‚å¸¸ [è‡ªåŠ¨æ£€æµ‹]"
        git push origin main

    - name: è¾“å‡ºæ£€æµ‹ç»“æžœ
      run: |
        echo "ðŸ“Š NASçŠ¶æ€æ£€æµ‹å®Œæˆ"
        echo "ðŸ” é€šçŸ¥çŠ¶æ€: ${{ steps.check-notification.outputs.status }}"
        echo "ðŸ”„ éœ€è¦æ›´æ–°: ${{ steps.check-notification.outputs.needs_update }}"
        echo "â° å½“å‰æ—¶é—´: $(date -u +'%Y-%m-%dT%H:%M:%S')"