name: NAS Status Monitor

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
  GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}

jobs:
  check-nas-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name "$GIT_USERNAME"
        git config --global user.email "$GIT_EMAIL"

    - name: æ£€æŸ¥NASé€šçŸ¥çŠ¶æ€
      id: check-notification
      run: |
        # æ£€æŸ¥data.jsonæ˜¯å¦å­˜åœ¨
        if [ ! -f "data.json" ]; then
          echo "data.json not found"
          exit 1
        fi

        # è§£æJSONå¹¶æ£€æŸ¥IDä¸º3çš„é€šçŸ¥
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S")
        NOTIFICATION_TIME=$(python -c "
        import json, sys
        from datetime import datetime, timedelta
        
        try:
            with open('data.json', 'r') as f:
                data = json.load(f)
            
            for notification in data.get('notifications', []):
                if notification.get('id') == 3:
                    print(notification.get('date', ''))
                    break
            else:
                print('NOT_FOUND')
                
        except Exception as e:
            print('ERROR')
        ")
        
        echo "Notification time: $NOTIFICATION_TIME"
        
        if [ "$NOTIFICATION_TIME" = "NOT_FOUND" ] || [ "$NOTIFICATION_TIME" = "ERROR" ]; then
          echo "status=not_found" >> $GITHUB_OUTPUT
          echo "needs_update=true" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡1.5å°æ—¶
          TIME_DIFF=$(python -c "
          from datetime import datetime, timedelta
          import sys
          
          current = datetime.utcnow()
          notification_time = datetime.strptime('$NOTIFICATION_TIME', '%Y-%m-%dT%H:%M:%S')
          diff = current - notification_time
          
          if diff.total_seconds() > 5400:  # 1.5å°æ—¶ = 5400ç§’
              print('true')
          else:
              print('false')
          ")
          
          echo "Time difference check: $TIME_DIFF"
          echo "status=exists" >> $GITHUB_OUTPUT
          echo "needs_update=$TIME_DIFF" >> $GITHUB_OUTPUT
        fi

    - name: æ›´æ–°å¼‚å¸¸çŠ¶æ€
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        python -c "
        import json
        from datetime import datetime
        
        # è¯»å–ç°æœ‰æ•°æ®
        with open('data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # æ›´æ–°IDä¸º3çš„é€šçŸ¥
        current_time = datetime.now().strftime('%Y-%m-%dT%H:%M:%S')
        nas_notification = None
        
        for notification in data['notifications']:
            if notification['id'] == 3:
                nas_notification = notification
                break
        
        if nas_notification:
            nas_notification['title'] = 'âŒ NASçŠ¶æ€å¼‚å¸¸ (è‡ªåŠ¨æ£€æµ‹)'
            nas_notification['content'] = 'ğŸ”´ NASçŠ¶æ€ç›‘æµ‹æŠ¥å‘Š - ' + current_time + '<br><br>GitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€é€šçŸ¥è¶…è¿‡1.5å°æ—¶æœªæ›´æ–°ï¼Œç³»ç»Ÿå¯èƒ½å·²ç¦»çº¿ã€‚<br><br>ğŸ“Š æœ€åæ£€æµ‹æ—¶é—´: ' + current_time + '<br><br>âš ï¸ æ³¨æ„: æ­¤çŠ¶æ€ç”±GitHub Actionè‡ªåŠ¨æ ‡è®°'
            nas_notification['date'] = current_time
        else:
            nas_notification = {
                'id': 3,
                'title': 'âŒ NASçŠ¶æ€å¼‚å¸¸ (è‡ªåŠ¨æ£€æµ‹)',
                'content': 'ğŸ”´ NASçŠ¶æ€ç›‘æµ‹æŠ¥å‘Š - ' + current_time + '<br><br>GitHub Actionæ£€æµ‹åˆ°NASçŠ¶æ€é€šçŸ¥é•¿æ—¶é—´æœªæ›´æ–°ã€‚<br><br>ğŸ“Š æœ€åæ£€æµ‹æ—¶é—´: ' + current_time + '<br><br>âš ï¸ æ³¨æ„: æ­¤çŠ¶æ€ç”±GitHub Actionè‡ªåŠ¨æ ‡è®°',
                'date': current_time
            }
            data['notifications'].append(nas_notification)
        
        # ä¿å­˜æ›´æ–°
        with open('data.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        
        print('âœ… å·²æ›´æ–°NASå¼‚å¸¸çŠ¶æ€')
        "

    - name: é…ç½®Gitè¿œç¨‹ä»“åº“è®¤è¯
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        # è·å–ä»“åº“URLå¹¶æ·»åŠ è®¤è¯ä¿¡æ¯
        REPO_URL="https://$GIT_USERNAME:$GIT_PASSWORD@github.com/${{ github.repository }}.git"
        git remote set-url origin $REPO_URL

    - name: æäº¤æ›´æ”¹
      if: steps.check-notification.outputs.needs_update == 'true'
      run: |
        git add data.json
        git commit -m "ğŸ¤– GitHub Action: æ ‡è®°NASçŠ¶æ€ä¸ºå¼‚å¸¸ [è‡ªåŠ¨æ£€æµ‹]"
        git push origin main

    - name: è¾“å‡ºæ£€æµ‹ç»“æœ
      run: |
        echo "ğŸ“Š NASçŠ¶æ€æ£€æµ‹å®Œæˆ"
        echo "ğŸ” é€šçŸ¥çŠ¶æ€: ${{ steps.check-notification.outputs.status }}"
        echo "ğŸ”„ éœ€è¦æ›´æ–°: ${{ steps.check-notification.outputs.needs_update }}"
        echo "â° å½“å‰æ—¶é—´: $(date -u +'%Y-%m-%dT%H:%M:%S')"